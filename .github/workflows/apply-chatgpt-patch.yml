name: Apply ChatGPT Patch

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  apply:
    if: >
      contains(github.event.comment.body, '/apply') &&
      (github.event.comment.author_association == 'OWNER' ||
       github.event.comment.author_association == 'MEMBER')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract patch from comment
        id: extract
        run: |
          node - <<'JS'
          const fs = require('fs');
          const body = process.env.BODY;
          const m = body.match(/```(?:patch|diff)\n([\s\S]*?)```/);
          if (!m) { throw new Error("No ```patch``` block found in comment"); }
          fs.writeFileSync('patch.diff', m[1], 'utf8');
          const direct = /\/apply\s+direct/i.test(body);
          fs.writeFileSync('mode.txt', direct ? 'direct' : 'pr', 'utf8');
          JS
        env:
          BODY: ${{ github.event.comment.body }}

      - name: Prepare git
        run: |
          git config user.name "chatgpt-patch-bot"
          git config user.email "chatgpt-patch-bot@users.noreply.github.com"

      - name: Apply patch
        run: |
          BRANCH="chatgpt/patch-${{ github.run_id }}"
          MODE="$(cat mode.txt)"
          if [ "$MODE" = "direct" ]; then
            git checkout -B main origin/main
            git apply -p1 --whitespace=fix patch.diff
            git add -A
            git commit -m "Apply patch from comment #${{ github.event.comment.id }} (direct)"
            git push origin main
          else
            git checkout -B "$BRANCH"
            git apply -p1 --whitespace=fix patch.diff
            git add -A
            git commit -m "Apply patch from comment #${{ github.event.comment.id }}"
            git push -u origin "$BRANCH"
          fi

      - name: Open PR (when not direct)
        if: ${{ hashFiles('mode.txt') && contains(steps.extract.outputs.undefined || '', 'dummy') == false && (success()) }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const mode = fs.readFileSync('mode.txt','utf8').trim();
            if (mode === 'direct') { return; }
            const { owner, repo } = context.repo;
            const head = "chatgpt/patch-${{ github.run_id }}";
            const base = "main";
            const title = "Apply patch from comment #${{ github.event.comment.id }}";
            const body = "Auto-generated by GitHub Actions (/apply).";
            await github.rest.pulls.create({ owner, repo, title, head, base, body });
